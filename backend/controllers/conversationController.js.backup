import { Conversation } from "../models/Conversation.js";
import { getIO } from "../socket.js";
import { getOnlineUsers } from "../socket.js";

// Get all conversations for a user
export const getConversations = async (userId) => {
  try {
    const conversations = await Conversation.find({
      participants: userId,
    }).populate("participants", "username email")
      .sort({ lastUpdated: -1 });

    return conversations;
  } catch (error) {
    throw new Error(error.message);
  }
};

// Create a new conversation
export const createConversation = async (participants) => {
  try {
    const conversation = new Conversation({ participants });
    await conversation.save();
    return conversation;
  } catch (error) {
    throw new Error(error.message);
  }
};

// Add a message to a conversation
export const addMessage = async (conversationId, senderId, text) => {
  try {
    const conversation = await Conversation.findById(conversationId);
    if (!conversation) throw new Error("Conversation not found");

    const message = { sender: senderId, text };
    conversation.messages.push(message);
    conversation.lastUpdated = new Date();
    await conversation.save();

    const io = getIO();
    io.to(`conv:${conversationId}`).emit("newMessage", { conversationId, message });

    // Direct notification to other participants
    const onlineUsers = getOnlineUsers();
    const recipients = conversation.participants
      .map((id) => id.toString())
      .filter((id) => id !== senderId);

    for (const recipientId of recipients) {
      const socketId = onlineUsers.get(recipientId);
      if (socketId) {
        io.to(socketId).emit("messageNotification", {
          conversationId,
          from: senderId,
          text,
          timestamp: new Date().toISOString(),
        });
      }
    }

    return message;
  } catch (error) {
    throw new Error(error.message);
  }
};

// Get messages of a conversation
export const getMessages = async (conversationId) => {
  try {
    const conversation = await Conversation.findById(conversationId)
      .populate("messages.sender", "username email");
    if (!conversation) throw new Error("Conversation not found");

    return conversation.messages;
  } catch (error) {
    throw new Error(error.message);
  }
};
